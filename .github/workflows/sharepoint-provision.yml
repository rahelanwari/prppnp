name: Provision SharePoint (PnP PowerShell)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "scripts/**"
      - ".github/workflows/**"

jobs:
  provision:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PnP PowerShell
        shell: pwsh
        run: |
          Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted
          Install-Module PnP.PowerShell -Force -Scope CurrentUser -AllowClobber

      # 1) Maak PFX file op runner (betrouwbaar pad) + sanity check
      - name: Write PFX from base64 (and sanity check)
        shell: pwsh
        env:
          CERT_PFX_BASE64: ${{ secrets.CERT_PFX_BASE64 }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:CERT_PFX_BASE64)) { throw "CERT_PFX_BASE64 is empty" }

          $pfxPath = Join-Path $env:TEMP "pnp-cert.pfx"
          $bytes = [Convert]::FromBase64String($env:CERT_PFX_BASE64)
          [IO.File]::WriteAllBytes($pfxPath, $bytes)

          $len = (Get-Item $pfxPath).Length
          Write-Host "PFX written to: $pfxPath"
          Write-Host "PFX size (bytes): $len"
          if ($len -lt 1000) { throw "PFX seems too small -> CERT_PFX_BASE64 is likely wrong/cut off" }

      # 2) Run jouw provisioning script (zonder nested pwsh)
      - name: Run provisioning script
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          SITE_URL: ${{ secrets.SITE_URL }}
          CERT_PASSWORD: ${{ secrets.CERT_PASSWORD }}
        run: |
          $pfxPath = Join-Path $env:TEMP "pnp-cert.pfx"

          if ([string]::IsNullOrWhiteSpace($env:TENANT_ID)) { throw "TENANT_ID is empty" }
          if ([string]::IsNullOrWhiteSpace($env:CLIENT_ID)) { throw "CLIENT_ID is empty" }
          if ([string]::IsNullOrWhiteSpace($env:SITE_URL)) { throw "SITE_URL is empty" }
          if ([string]::IsNullOrWhiteSpace($env:CERT_PASSWORD)) { throw "CERT_PASSWORD is empty" }
          if (!(Test-Path $pfxPath)) { throw "PFX file not found at $pfxPath" }

          # Geef pad mee aan je script
          ./scripts/Provision-SharePoint.ps1 -PfxPath $pfxPath
